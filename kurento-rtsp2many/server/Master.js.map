{"version":3,"sources":["server/Master.ts"],"names":["Master","Master.constructor","Master.id","Master.streamUrl","Master.removeViewer","Master.status","Master.isOnline","Master.isOffline","Master.viewers","Master.startStream","Master.addViewer","Master.addViewerToPlayer","Master.stopStartStreamProcessWithError","Master.stopStream","Master.disposeMasterMediaObjects"],"mappings":"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","file":"server/Master.js","sourcesContent":["/// <reference path=\"../typings/kurento-client.d.ts\" />\r\n/// <reference path=\"../typings/kurento-utils.d.ts\" />\r\n/// <reference path=\"./Viewer.ts\" />\r\n/// <reference path=\"./KurentoClientManager.ts\" />\r\n\r\nimport KurentoClientManager = require('./KurentoClientManager');\r\n\r\nclass Master {\r\n\r\n    constructor(id: string, streamUrl: string, pipeline: Kurento.Client.IMediaPipeline, private kurentoClientManager: KurentoClientManager) {\r\n        this._id = id;\r\n        this._streamUrl = streamUrl;\r\n        this._pipeline = pipeline;\r\n    }\r\n\r\n    get id(): string {\r\n        return this._id;\r\n    }\r\n    private _id: string;\r\n\r\n    get streamUrl(): string {\r\n        return this._streamUrl;\r\n    }\r\n    private _streamUrl: string;\r\n\r\n    _viewers: Viewer[] = [];\r\n\r\n    private _pipeline: Kurento.Client.IMediaPipeline = null;\r\n\r\n    private _player: Kurento.Client.IPlayerEndpoint = null;\r\n    private playerCreationStarted: boolean = false;\r\n\r\n    private _webRtcEndpoint: Kurento.Client.IWebRtcEndpoint = null;\r\n\r\n    private _webRtcPeer = null;\r\n\r\n    removeViewer(viewer) {\r\n        var index = this._viewers.indexOf(viewer);\r\n        if (index == -1)\r\n            return;\r\n\r\n        this._viewers.splice(index, 1);\r\n\r\n        if (!this._viewers.length && this.isOnline)\r\n            this.stopStream();\r\n    };\r\n\r\n    get status(): string {\r\n        return !!this._pipeline ? 'online' : 'offline';\r\n    }\r\n\r\n    get isOnline(): boolean {\r\n        return !!this._pipeline;\r\n    }\r\n\r\n    get isOffline(): boolean {\r\n        return !this._pipeline;\r\n    }\r\n\r\n    get viewers(): Object[] {\r\n        return this._viewers;\r\n    }\r\n\r\n    startStream(callback: (err, player?: Kurento.Client.IPlayerEndpoint) => void) {\r\n        if (this.isOnline) {\r\n            console.warn('WARNING! Trying to start an already running stream');\r\n            return;\r\n        }\r\n        this.playerCreationStarted = true;\r\n\r\n        this.kurentoClientManager.findOrCreateClient((err, kurentoClient) => {\r\n            if (err) {\r\n                return this.stopStartStreamProcessWithError('Failed to find or create KurentoClient.', err);\r\n            }\r\n\r\n            kurentoClient.client.create('MediaPipeline', (err, p) => {\r\n                if (err) {\r\n                    return callback('An error occurred while master #' + this.id + ' trying to create media pieline' + err.toString());\r\n                }\r\n\r\n                console.log('MediaPipeline created for Master #', this.id);\r\n                this._pipeline = p;\r\n\r\n                this._pipeline.create(\"PlayerEndpoint\", { uri: this._streamUrl }, (err, player: Kurento.Client.IPlayerEndpoint) => {\r\n                    if (err) {\r\n                        return callback('An error occurred while master #' + this.id + ' trying to create endpoint player. ' + err.toString());\r\n                    }\r\n\r\n                    console.log('PlayerEndpoint created for Master #', this.id, '. Stream URL:', this._streamUrl);\r\n\r\n                    this._player = player;\r\n                    callback(null, player);\r\n                })\r\n            });\r\n        });\r\n    }\r\n\r\n    public addViewer(viewer: Viewer, callback: (err, sdpAnswer?: string) => void): void {\r\n        if (this._viewers.some(v => v.sessionId == viewer.sessionId)) {\r\n            console.warn(\"Viewer #\", viewer.sessionId, \" is already added to Master #\", this.id);\r\n            return\r\n        }\r\n\r\n        this._viewers.push(viewer);\r\n\r\n        if (this._player) {\r\n            console.log('PlayerEndpoint already created. Reusing existing one...');\r\n            this.addViewerToPlayer(this._player, viewer, callback);\r\n        } else {\r\n            console.log('Creating PlayerEndpoint...');\r\n            this.startStream((err, player) => {\r\n                if (err)\r\n                    return console.error('Failed to Add Viewer because of failure during startStream.');\r\n                this.addViewerToPlayer(player, viewer, callback);\r\n            });\r\n        }\r\n    }\r\n\r\n    private addViewerToPlayer(player: Kurento.Client.IPlayerEndpoint, viewer: Viewer, callback: (err, sdpAnswer?: string) => void): void {\r\n        this._pipeline.create('WebRtcEndpoint', (err, webRtcEndpoint) => {\r\n            if (err)\r\n                return callback('An error occurred while master #' + this.id + ' trying to create WebRtc endpoint' + err.toString());\r\n\r\n            console.log('WebRtcEndpoint created for Master #', this.id);\r\n            this._webRtcEndpoint = webRtcEndpoint;\r\n\r\n            var finalSdpAnswer = null,\r\n                playerPlaying = false;\r\n\r\n            this._webRtcEndpoint.processOffer(viewer.sdpOffer, (err, sdpAnswer) => {\r\n                if (err)\r\n                    return callback('An error occurred while WebRtc endpoint of master #' + this.id + 'trying to process offer' + err.toString());\r\n\r\n                console.log('SdpOffer processed for Master #', this.id, ' SdpOffer:', viewer.sdpOffer, '. SdpAnswer:', sdpAnswer);\r\n                finalSdpAnswer = sdpAnswer;\r\n                if (playerPlaying)\r\n                    callback(null, finalSdpAnswer);\r\n            });\r\n\r\n            this._pipeline.create('GStreamerFilter', { command: 'capsfilter caps=video/x-raw,framerate=25/1', filterType: \"VIDEO\" }, (err, gstFilter) => {\r\n                if (err)\r\n                    return console.error(\"Failed to create GStreamerFilter.\", err);\r\n\r\n                console.log(\"Successfully created GStreamerFilter.\", err);\r\n                player.connect(gstFilter, err => {\r\n                    if (err)\r\n                        return console.error(\"Failed to connect PLayerEndpoint to GStreamerFilter.\", err);\r\n\r\n                    console.log(\"Successfully connected PLayerEndpoint to GStreamerFilter.\", err);\r\n                    gstFilter.connect(this._webRtcEndpoint, err => {\r\n                        if (err)\r\n                            return console.error(\"Failed to connect GStreamerFilter to WebRtcEndpoint\", err);\r\n\r\n                        console.log(\"Successfully connected GStreamerFilter to WebRtcEndpoint.\", err);\r\n                        player.play(err => {\r\n                            if (err)\r\n                                return console.error('Failed to start playing.');\r\n\r\n                            console.log('Successfully started playing by PlayerEndpoint');\r\n                            playerPlaying = true;\r\n                            if (finalSdpAnswer)\r\n                                callback(null, finalSdpAnswer);\r\n                        });\r\n                    });\r\n                });\r\n            });\r\n        });\r\n    }\r\n\r\n    private stopStartStreamProcessWithError(message: string, error: any = null) {\r\n        console.error('ERROR! ' + message, error || '');\r\n\r\n        this.disposeMasterMediaObjects();\r\n\r\n        return message;\r\n    }\r\n\r\n    stopStream() {\r\n\r\n        throw new Error('Not implemented yet. Эта функция должна проставлять pipeline на null');\r\n\r\n        //закрыть вьюверы тут\r\n\r\n        this.disposeMasterMediaObjects();\r\n    }\r\n\r\n    disposeMasterMediaObjects() {\r\n        if (this._webRtcPeer)\r\n            this._webRtcPeer.dispose();\r\n\r\n        this._webRtcPeer = null;\r\n\r\n        if (this._pipeline)\r\n            this._pipeline.release();\r\n\r\n        this._pipeline = null;\r\n\r\n        if (this._webRtcEndpoint)\r\n            this._webRtcEndpoint.release();\r\n\r\n        this._webRtcEndpoint = null;\r\n    }\r\n}\r\n\r\nexport = Master"],"sourceRoot":"../"}