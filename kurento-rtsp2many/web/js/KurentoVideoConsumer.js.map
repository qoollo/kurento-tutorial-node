{"version":3,"sources":["web/js/KurentoVideoConsumer.ts"],"names":["KurentoVideoConsumer","KurentoVideoConsumer.constructor","KurentoVideoConsumer.playStream","KurentoVideoConsumer.dispose","KurentoVideoConsumer.authenticate","KurentoVideoConsumer.retrieveCredentials"],"mappings":"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","file":"web/js/KurentoVideoConsumer.js","sourcesContent":["\r\nimport ConnectionState = require('../../server/ConnectionState');\r\nimport KurentoHubClient = require('./KurentoHubClient');\r\nimport KurentoPlayer = require('./KurentoPlayer');\r\n\r\nclass KurentoVideoConsumer {\r\n\r\n    constructor(kurentoHubDomain: string, logger: Console = console) {\r\n        this.logger = logger;\r\n\r\n        this.hub = new KurentoHubClient(KurentoVideoConsumer.crossbarConfig, kurentoHubDomain, logger);\r\n    }\r\n\r\n    private logger: Console;\r\n    private hub: KurentoHubClient = null;\r\n\r\n    public playStream(streamUrl: string): Promise<KurentoPlayer> {\r\n        var promise: Promise<any>;\r\n        if (this.hub.state == ConnectionState.NotCreated) {\r\n            promise = this.hub.start();\r\n        } else\r\n            promise = Promise.resolve();\r\n        return promise\r\n            .then(() => this.authenticate())\r\n            .then(c => {\r\n                this.logger.log('Ready to start stream');\r\n                return new KurentoPlayer('');\r\n            });\r\n    }\r\n\r\n    public dispose(): void {\r\n        this.hub.stop();\r\n    }\r\n    \r\n    private authenticate(): Promise<Protocol.IClientId> {\r\n        return this.retrieveCredentials()\r\n            .then(c => {\r\n                var res: Promise<Protocol.IClientId>;\r\n                if (c && c.clientId) {\r\n                    this.logger.log('Already authorized as ' + c.clientId);\r\n                    res = Promise.resolve(c);\r\n                } else {\r\n                    this.logger.log('Not authorized yet. Registering...');\r\n                    res = this.hub.register();\r\n                    res.then(cc => this.logger.log('Successfully registered as ' + cc.clientId),\r\n                        err => this.logger.error('Failed to register.' + err));\r\n                }\r\n                return res;                \r\n            })\r\n    }\r\n    \r\n    retrieveCredentials(): Promise<Protocol.IClientId> {\r\n        var str = localStorage.getItem(KurentoVideoConsumer.credentialsKey),\r\n            res = <Protocol.IClientId>JSON.parse(str);\r\n        return Promise.resolve(res);\r\n    }\r\n    \r\n    private static credentialsKey: string = 'KurentoHubClientCredentials';\r\n\r\n    private static crossbarConfig = {\r\n        \"type\": \"web\",\r\n        \"endpoint\": {\r\n            \"type\": \"tcp\",\r\n            \"port\": 8080\r\n        },\r\n        \"paths\": {\r\n            \"/\": {\r\n                \"type\": \"static\",\r\n                \"directory\": \"../web\"\r\n            },\r\n            \"ws\": {\r\n                \"type\": \"websocket\"\r\n            },\r\n            \"kurentoHub\": {\r\n                \"type\": \"websocket\",\r\n                \"auth\": {\r\n                    \"wampcra\": {\r\n                        \"type\": \"static\",\r\n                        \"users\": {\r\n                            \"KurentoHub\": {\r\n                                \"secret\": \"secret2\",\r\n                                \"role\": \"KurentoHub\"\r\n                            },\r\n                            \"VideoConsumer\": {\r\n                                \"secret\": \"prq7+YkJ1/KlW1X0YczMHw==\",\r\n                                \"role\": \"VideoConsumer\",\r\n                                \"salt\": \"salt123\",\r\n                                \"iterations\": 100,\r\n                                \"keylen\": 16\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n}\r\n\r\nexport = KurentoVideoConsumer;"],"sourceRoot":"../"}