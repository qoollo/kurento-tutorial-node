{"version":3,"sources":["web/js/index.ts"],"names":["handleMasterResponse","handleViewerResponse","onMasterClick","onViewerClick","onTerminateClick","dispose","sendMessage","showSpinner","hideSpinner"],"mappings":"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","file":"web/js/index.js","sourcesContent":["/*\r\n * (C) Copyright 2014 Kurento (http://kurento.org/)\r\n *\r\n * All rights reserved. This program and the accompanying materials\r\n * are made available under the terms of the GNU Lesser General Public License\r\n * (LGPL) version 2.1 which accompanies this distribution, and is available at\r\n * http://www.gnu.org/licenses/lgpl-2.1.html\r\n *\r\n * This library is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport ConsoleWrapper = require('./Console')\r\nvar KurentoVideoConsumer = require('./KurentoVideoConsumer.js')\r\n\r\nvar ws,\r\n    video,\r\n    webRtcPeer,\r\n    streamUrl = 'rtsp://10.5.5.85/media/video1',\r\n    client,\r\n    crossbarConfig = {\r\n        \"type\": \"web\",\r\n        \"endpoint\": {\r\n            \"type\": \"tcp\",\r\n            \"port\": 8080\r\n        },\r\n        \"paths\": {\r\n            \"/\": {\r\n                \"type\": \"static\",\r\n                \"directory\": \"../web\"\r\n            },\r\n            \"ws\": {\r\n                \"type\": \"websocket\"\r\n            },\r\n            \"kurentoHub\": {\r\n                \"type\": \"websocket\",\r\n                \"auth\": {\r\n                    \"wampcra\": {\r\n                        \"type\": \"static\",\r\n                        \"users\": {\r\n                            \"KurentoHub\": {\r\n                                \"secret\": \"secret2\",\r\n                                \"role\": \"KurentoHub\"\r\n                            },\r\n                            \"VideoConsumer\": {\r\n                                \"secret\": \"prq7+YkJ1/KlW1X0YczMHw==\",\r\n                                \"role\": \"VideoConsumer\",\r\n                                \"salt\": \"salt123\",\r\n                                \"iterations\": 100,\r\n                                \"keylen\": 16\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\nwindow.onload = function () {\r\n    console = <any>(new ConsoleWrapper('console', console));\r\n    video = document.getElementById('video');\r\n\r\n    var address = (<HTMLInputElement>document.getElementById('app-server-address')).value;\r\n\r\n    client = new KurentoVideoConsumer(address.substring(0, address.lastIndexOf(':')), console);\r\n    client.playStream();\r\n    return;\r\n\r\n    ws = new WebSocket('ws://' + address + '/control');\r\n    ws.onmessage = function (message) {\r\n        var parsedMessage = JSON.parse(message.data);\r\n        console.info('Received message: ' + message.data);\r\n\r\n        switch (parsedMessage.id) {\r\n            case 'masterResponse':\r\n                handleMasterResponse(parsedMessage);\r\n                break;\r\n            case 'viewerResponse':\r\n                handleViewerResponse(parsedMessage);\r\n                break;\r\n            case 'stopCommunication':\r\n                dispose();\r\n                break;\r\n            default:\r\n                debugger;\r\n                if (parsedMessage.data && parsedMessage.data.rpc == 'AddViewerResponse')\r\n                    webRtcPeer.processSdpAnswer(parsedMessage.data.sdpAnswer, function () {\r\n                        console.info('SdpAnswer processed');\r\n                    });\r\n                else\r\n                    console.error('Unrecognized message', parsedMessage);\r\n        }\r\n    }\r\n\r\n    document.getElementById('call').onclick = onMasterClick;\r\n    document.getElementById('viewer').onclick = onViewerClick;\r\n    document.getElementById('terminate').onclick = onTerminateClick;\r\n}\r\n\r\nwindow.onbeforeunload = function () {\r\n    if (client)\r\n        client.dispose();\r\n    if (ws)\r\n        ws.close();\r\n}\r\n\r\nfunction handleMasterResponse(message) {\r\n    if (message.response != 'accepted') {\r\n        var errorMsg = message.message ? message.message : 'Unknow error';\r\n        console.info('Call not accepted for the following reason: ' + errorMsg);\r\n        dispose();\r\n    } else {\r\n        webRtcPeer.processSdpAnswer(message.sdpAnswer);\r\n    }\r\n}\r\n\r\nfunction handleViewerResponse(message) {\r\n    if (message.response != 'accepted') {\r\n        var errorMsg = message.message ? message.message : 'Unknow error';\r\n        console.info('Call not accepted for the following reason: ' + errorMsg);\r\n        dispose();\r\n    } else {\r\n        webRtcPeer.processSdpAnswer(message.sdpAnswer);\r\n    }\r\n}\r\n\r\nfunction onMasterClick() {\r\n    var message = {\r\n        rpc: 'AddMaster',\r\n        params: {\r\n            streamUrl: streamUrl\r\n        }\r\n    };\r\n    sendMessage(message);\r\n\r\n    return false;\r\n}\r\n\r\nfunction onViewerClick() {\r\n    if (!webRtcPeer) {\r\n        showSpinner(video);\r\n\r\n        webRtcPeer = kurentoUtils.WebRtcPeer.startRecvOnly(video, function (offerSdp) {\r\n            var message = {\r\n                rpc: 'AddViewer',\r\n                params: {\r\n                    sdpOffer: offerSdp,\r\n                    streamUrl: streamUrl\r\n                }\r\n            };\r\n            sendMessage(message);\r\n        });\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\nfunction onTerminateClick() {\r\n    var message = {\r\n        id: 'stop'\r\n    }\r\n    sendMessage(message);\r\n    dispose();\r\n\r\n    return false;\r\n}\r\n\r\nfunction dispose() {\r\n    if (webRtcPeer) {\r\n        webRtcPeer.dispose();\r\n        webRtcPeer = null;\r\n    }\r\n    hideSpinner(video);\r\n}\r\n\r\nfunction sendMessage(message) {\r\n    var jsonMessage = JSON.stringify(message);\r\n    console.log('Senging message: ' + jsonMessage);\r\n    ws.send(jsonMessage);\r\n}\r\n\r\nfunction showSpinner(...elements: HTMLVideoElement[]) {\r\n    elements.forEach(e => {\r\n        e.poster = './img/transparent-1px.png';\r\n        e.style.background = 'center transparent url(\"./img/spinner.gif\") no-repeat';\r\n    });\r\n}\r\n\r\nfunction hideSpinner(...elements: HTMLVideoElement[]) {\r\n    elements.forEach(e => {\r\n        e.src = '';\r\n        e.poster = './img/webrtc.png';\r\n        e.style.background = '';\r\n    });\r\n}\r\n\r\n/**\r\n * Lightbox utility (to display media pipeline image in a modal dialog)\r\n */\r\n$(document).delegate('*[data-toggle=\"lightbox\"]', 'click', function (event) {\r\n    event.preventDefault();\r\n    (<any>$(this)).ekkoLightbox();\r\n});\r\n"],"sourceRoot":"../"}